# Rule Comparison Improvements

## Problem

The original rule comparison in `rulesNeedUpdate()` was using a simple byte comparison:

```go
return string(desiredBytes) != string(currentBytes), nil
```

This approach was too strict and caused several issues:

1. **Field Ordering**: JSON field ordering differences would trigger false positives
2. **Auto-generated Fields**: Akamai API responses include auto-generated fields (UUIDs, timestamps, etags) that shouldn't affect comparison
3. **Empty Values**: Default/empty values might be present in one structure but not the other
4. **Format Differences**: Akamai API format vs. our custom structure format differences

## Solution

Implemented a more intelligent comparison that:

### 1. Normalizes Current Rules
- Converts Akamai API response to our `PropertyRules` structure
- Removes auto-generated and irrelevant fields

### 2. Cleans Rules for Comparison
- Removes/resets auto-generated UUIDs
- Filters out empty string values
- Normalizes behavior and criteria options
- Recursively cleans child rules

### 3. Deep Comparison
- Creates clean copies of both desired and current rules
- Normalizes JSON representation for consistent ordering
- Performs byte comparison on normalized structures

## Key Features

### Auto-generated Field Filtering
Removes fields that are auto-generated by Akamai:
- `uuid` - Rule/behavior/criteria UUIDs
- `templateUuid` - Template UUIDs
- `lastModified` - Timestamps
- `created` - Creation timestamps
- `etag` - Entity tags
- `ruleFormat` - Format versions

### Empty Value Handling
Filters out empty string values that represent default/unset values.

### Recursive Processing
Handles nested child rules by recursively applying the same cleaning logic.

## Testing

Comprehensive test suite covers:
- Identical rules detection
- Meaningful difference detection
- Auto-generated field ignoring
- Empty value filtering
- Complex nested rule structures

## Usage

The improvement is transparent to existing code. The `rulesNeedUpdate()` function maintains the same interface:

```go
needsUpdate, err := r.rulesNeedUpdate(desired, current)
```

But now provides much more accurate detection of meaningful rule changes.