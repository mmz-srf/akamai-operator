name: Validate Metadata

on:
  push:
    paths:
      - 'artifacthub-pkg.yml'
      - 'bundle/**'
      - '.github/workflows/validate-metadata.yml'
  pull_request:
    paths:
      - 'artifacthub-pkg.yml'
      - 'bundle/**'
      - '.github/workflows/validate-metadata.yml'

jobs:
  validate-artifacthub:
    name: Validate ArtifactHub Metadata
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Install yq for YAML processing
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq

    - name: Validate artifacthub-pkg.yml structure
      run: |
        echo "Validating artifacthub-pkg.yml..."
        
        # Check required fields
        REQUIRED_FIELDS=(
          "name"
          "version"
          "displayName"
          "description"
          "license"
          "operator"
          "install"
        )
        
        for field in "${REQUIRED_FIELDS[@]}"; do
          VALUE=$(yq eval ".$field" artifacthub-pkg.yml)
          if [[ "$VALUE" == "null" || "$VALUE" == "" ]]; then
            echo "❌ Error: Required field '$field' is missing or empty"
            exit 1
          else
            echo "✅ Field '$field': $VALUE"
          fi
        done
        
        # Validate specific field formats
        NAME=$(yq eval ".name" artifacthub-pkg.yml)
        if [[ ! "$NAME" =~ ^[a-z0-9-]+$ ]]; then
          echo "❌ Error: Name '$NAME' contains invalid characters (only lowercase alphanumeric and hyphens allowed)"
          exit 1
        fi
        
        VERSION=$(yq eval ".version" artifacthub-pkg.yml)
        if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "❌ Error: Version '$VERSION' is not in valid semver format (X.Y.Z)"
          exit 1
        fi
        
        LICENSE=$(yq eval ".license" artifacthub-pkg.yml)
        if [[ "$LICENSE" != "Apache-2.0" ]]; then
          echo "⚠️  Warning: License is '$LICENSE', expected 'Apache-2.0'"
        fi
        
        echo "✅ artifacthub-pkg.yml validation passed"

    - name: Validate container images format
      run: |
        echo "Validating container images..."
        
        # Check if containersImages exists and has valid format
        IMAGES_COUNT=$(yq eval ".containersImages | length" artifacthub-pkg.yml)
        if [[ "$IMAGES_COUNT" == "0" || "$IMAGES_COUNT" == "null" ]]; then
          echo "❌ Error: No container images specified"
          exit 1
        fi
        
        for ((i=0; i<$IMAGES_COUNT; i++)); do
          IMAGE_NAME=$(yq eval ".containersImages[$i].name" artifacthub-pkg.yml)
          IMAGE_URL=$(yq eval ".containersImages[$i].image" artifacthub-pkg.yml)
          
          if [[ "$IMAGE_NAME" == "null" || "$IMAGE_NAME" == "" ]]; then
            echo "❌ Error: Container image $i missing name"
            exit 1
          fi
          
          if [[ "$IMAGE_URL" == "null" || "$IMAGE_URL" == "" ]]; then
            echo "❌ Error: Container image $i missing image URL"
            exit 1
          fi
          
          # Validate image URL format
          if [[ ! "$IMAGE_URL" =~ ^ghcr\.io/.+:.+ ]]; then
            echo "⚠️  Warning: Image URL '$IMAGE_URL' may not be in expected format"
          fi
          
          echo "✅ Container image $i: $IMAGE_NAME -> $IMAGE_URL"
        done

    - name: Validate install command
      run: |
        echo "Validating install command..."
        
        INSTALL_CMD=$(yq eval ".install" artifacthub-pkg.yml)
        if [[ ! "$INSTALL_CMD" =~ kubectl.*apply.*-f.*github\.com/.*/releases/download/.*/akamai-operator\.yaml ]]; then
          echo "⚠️  Warning: Install command may not follow expected pattern"
          echo "Expected: kubectl apply -f https://github.com/.../releases/download/.../akamai-operator.yaml"
          echo "Actual: $INSTALL_CMD"
        else
          echo "✅ Install command format is valid"
        fi

  validate-bundle:
    name: Validate OLM Bundle
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Install operator-sdk
      run: |
        RELEASE_VERSION=v1.34.1
        curl -LO https://github.com/operator-framework/operator-sdk/releases/download/${RELEASE_VERSION}/operator-sdk_linux_amd64
        chmod +x operator-sdk_linux_amd64
        sudo mv operator-sdk_linux_amd64 /usr/local/bin/operator-sdk

    - name: Install yq for YAML processing
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq

    - name: Validate bundle structure
      run: |
        echo "Validating bundle structure..."
        
        # Check required directories and files
        if [[ ! -d "bundle" ]]; then
          echo "❌ Error: bundle/ directory not found"
          exit 1
        fi
        
        if [[ ! -d "bundle/manifests" ]]; then
          echo "❌ Error: bundle/manifests/ directory not found"
          exit 1
        fi
        
        if [[ ! -d "bundle/metadata" ]]; then
          echo "❌ Error: bundle/metadata/ directory not found"
          exit 1
        fi
        
        if [[ ! -f "bundle/metadata/annotations.yaml" ]]; then
          echo "❌ Error: bundle/metadata/annotations.yaml not found"
          exit 1
        fi
        
        CSV_FILES=(bundle/manifests/*.clusterserviceversion.yaml)
        if [[ ! -f "${CSV_FILES[0]}" ]]; then
          echo "❌ Error: No ClusterServiceVersion file found in bundle/manifests/"
          exit 1
        fi
        
        echo "✅ Bundle structure is valid"

    - name: Validate bundle annotations
      run: |
        echo "Validating bundle annotations..."
        
        ANNOTATIONS_FILE="bundle/metadata/annotations.yaml"
        
        # Check required annotations
        REQUIRED_ANNOTATIONS=(
          "operators.operatorframework.io/bundle.mediatype.v1"
          "operators.operatorframework.io/bundle.manifests.v1"
          "operators.operatorframework.io/bundle.metadata.v1"
          "operators.operatorframework.io/bundle.package.v1"
          "operators.operatorframework.io/bundle.channels.v1"
          "operators.operatorframework.io/bundle.channel.default.v1"
        )
        
        for annotation in "${REQUIRED_ANNOTATIONS[@]}"; do
          VALUE=$(yq eval ".annotations.\"$annotation\"" $ANNOTATIONS_FILE)
          if [[ "$VALUE" == "null" || "$VALUE" == "" ]]; then
            echo "❌ Error: Required annotation '$annotation' is missing"
            exit 1
          else
            echo "✅ Annotation '$annotation': $VALUE"
          fi
        done

    - name: Validate ClusterServiceVersion
      run: |
        echo "Validating ClusterServiceVersion..."
        
        CSV_FILE=$(find bundle/manifests -name "*.clusterserviceversion.yaml" | head -1)
        
        # Check required fields
        CSV_NAME=$(yq eval ".metadata.name" "$CSV_FILE")
        CSV_VERSION=$(yq eval ".spec.version" "$CSV_FILE")
        DISPLAY_NAME=$(yq eval ".spec.displayName" "$CSV_FILE")
        DESCRIPTION=$(yq eval ".spec.description" "$CSV_FILE")
        
        if [[ "$CSV_NAME" == "null" || "$CSV_NAME" == "" ]]; then
          echo "❌ Error: CSV metadata.name is missing"
          exit 1
        fi
        
        if [[ "$CSV_VERSION" == "null" || "$CSV_VERSION" == "" ]]; then
          echo "❌ Error: CSV spec.version is missing"
          exit 1
        fi
        
        if [[ "$DISPLAY_NAME" == "null" || "$DISPLAY_NAME" == "" ]]; then
          echo "❌ Error: CSV spec.displayName is missing"
          exit 1
        fi
        
        if [[ "$DESCRIPTION" == "null" || "$DESCRIPTION" == "" ]]; then
          echo "❌ Error: CSV spec.description is missing"
          exit 1
        fi
        
        # Validate version format
        if [[ ! "$CSV_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "❌ Error: CSV version '$CSV_VERSION' is not in valid semver format"
          exit 1
        fi
        
        echo "✅ CSV validation passed"
        echo "  Name: $CSV_NAME"
        echo "  Version: $CSV_VERSION"
        echo "  Display Name: $DISPLAY_NAME"

    - name: Validate bundle with operator-sdk
      run: |
        echo "Validating bundle with operator-sdk..."
        operator-sdk bundle validate ./bundle --select-optional suite=operatorframework
        echo "✅ operator-sdk bundle validation passed"

  validate-consistency:
    name: Validate Version Consistency
    runs-on: ubuntu-latest
    needs: [validate-artifacthub, validate-bundle]
    steps:
    - name: Checkout
      uses: actions/checkout@v5

    - name: Install yq for YAML processing
      run: |
        sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
        sudo chmod +x /usr/local/bin/yq

    - name: Check version consistency
      run: |
        echo "Checking version consistency across files..."
        
        # Get versions from different files
        ARTIFACTHUB_VERSION=$(yq eval ".version" artifacthub-pkg.yml)
        ARTIFACTHUB_APP_VERSION=$(yq eval ".appVersion" artifacthub-pkg.yml)
        
        CSV_FILE=$(find bundle/manifests -name "*.clusterserviceversion.yaml" | head -1)
        CSV_VERSION=$(yq eval ".spec.version" "$CSV_FILE")
        
        echo "ArtifactHub version: $ARTIFACTHUB_VERSION"
        echo "ArtifactHub appVersion: $ARTIFACTHUB_APP_VERSION"
        echo "CSV version: $CSV_VERSION"
        
        # Check if all versions match
        if [[ "$ARTIFACTHUB_VERSION" != "$ARTIFACTHUB_APP_VERSION" ]]; then
          echo "❌ Error: ArtifactHub version ($ARTIFACTHUB_VERSION) doesn't match appVersion ($ARTIFACTHUB_APP_VERSION)"
          exit 1
        fi
        
        if [[ "$ARTIFACTHUB_VERSION" != "$CSV_VERSION" ]]; then
          echo "❌ Error: ArtifactHub version ($ARTIFACTHUB_VERSION) doesn't match CSV version ($CSV_VERSION)"
          exit 1
        fi
        
        echo "✅ All versions are consistent: $ARTIFACTHUB_VERSION"

    - name: Check image consistency
      run: |
        echo "Checking container image consistency..."
        
        # Get image from ArtifactHub
        ARTIFACTHUB_IMAGE=$(yq eval ".containersImages[0].image" artifacthub-pkg.yml)
        
        # Get image from CSV (if specified in annotations)
        CSV_FILE=$(find bundle/manifests -name "*.clusterserviceversion.yaml" | head -1)
        CSV_IMAGE_ANNOTATION=$(yq eval ".metadata.annotations.\"artifacthub.io/containersImages\"" "$CSV_FILE")
        
        echo "ArtifactHub image: $ARTIFACTHUB_IMAGE"
        echo "CSV image annotation: $CSV_IMAGE_ANNOTATION"
        
        # Extract version from image tag
        if [[ "$ARTIFACTHUB_IMAGE" =~ :v([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          IMAGE_VERSION="${BASH_REMATCH[1]}"
          ARTIFACTHUB_VERSION=$(yq eval ".version" artifacthub-pkg.yml)
          
          if [[ "$IMAGE_VERSION" != "$ARTIFACTHUB_VERSION" ]]; then
            echo "⚠️  Warning: Image version ($IMAGE_VERSION) doesn't match package version ($ARTIFACTHUB_VERSION)"
          else
            echo "✅ Image version matches package version: $IMAGE_VERSION"
          fi
        else
          echo "⚠️  Warning: Could not extract version from image tag"
        fi